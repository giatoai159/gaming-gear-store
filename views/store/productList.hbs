
<!-- SECTION -->
<div class="section">
    <!-- container -->
    <div class="container">
        <!-- row -->
        <div class="row">
            <!-- ASIDE -->
            <div id="aside" class="col-md-3">
                <div class="aside">
                    <button id="reset-btn" class="primary-btn">reset filter</button>
                </div>
                <form method="get">
                <!-- aside Category Widget -->
                <div class="aside">
                    <h3 class="aside-title">Categories</h3>
                    <div class="checkbox-filter">
                        {{#each categories}}
                        <div class="input-radio">
                            <input class="category-filter" type="radio" name="category" id="category-{{category}}" value="{{category}}">
                            <label for="category-{{category}}">
                                <span></span>
                                {{'category_category.nameCategory'}}
                                
                            </label>
                        </div>
                        {{/each}}
                    </div>
                </div>
                <!-- /aside Category Widget -->

                <!-- aside Brand Widget -->
                <div class="aside">
                    <h3 class="aside-title">Brand</h3>
                    {{!-- <form> --}}
                    <div class="checkbox-filter">
                        {{#each brands}}
                        <div class="input-radio">
                            <input class="brand-filter" type="radio" name="brand" id="brand-{{lowerCase brand}}" value="{{brand}}">
                            <label for="brand-{{lowerCase brand}}">
                                <span></span>
                                {{brand}}
                            </label>
                        </div>
                        {{/each}}
                    </div>
                </div>
                <!-- /aside Brand Widget -->

                <!-- aside Rating Widget -->
                <div class="aside">
                    <h3 class="aside-title">Rating</h3>
                    <div class="checkbox-filter">
                        <div class="input-radio">
                            <input class="rating-filter" type="radio" name="rating" id="rating-4" value="4">
                            <label for="rating-4">
                                <span></span>
                                <i class="fa fa-star star-red"></i>
                                <i class="fa fa-star star-red"></i>
                                <i class="fa fa-star star-red"></i>
                                <i class="fa fa-star star-red"></i>
                                <i class="fa fa-star-o star-red"></i>
                                and up
                                {{!-- <small>({{numProducts}})</small> --}}
                            </label>
                        </div>
                        <div class="input-radio">
                            <input class="rating-filter" type="radio" name="rating" id="rating-3" value="3">
                            <label for="rating-3">
                                <span></span>
                                <i class="fa fa-star star-red"></i>
                                <i class="fa fa-star star-red"></i>
                                <i class="fa fa-star star-red"></i>
                                <i class="fa fa-star-o star-red"></i>
                                <i class="fa fa-star-o star-red"></i>
                                and up
                                {{!-- <small>({{numProducts}})</small> --}}
                            </label>
                        </div>
                        <div class="input-radio">
                            <input class="rating-filter" type="radio" name="rating" id="rating-2" value="2">
                            <label for="rating-2">
                                <span></span>
                                <i class="fa fa-star star-red"></i>
                                <i class="fa fa-star star-red"></i>
                                <i class="fa fa-star-o star-red"></i>
                                <i class="fa fa-star-o star-red"></i>
                                <i class="fa fa-star-o star-red"></i>
                                and up
                                {{!-- <small>({{numProducts}})</small> --}}
                            </label>
                        </div>
                        <div class="input-radio">
                            <input class="rating-filter" type="radio" name="rating" id="rating-1" value="1">
                            <label for="rating-1">
                                <span></span>
                                <i class="fa fa-star star-red"></i>
                                <i class="fa fa-star-o star-red"></i>
                                <i class="fa fa-star-o star-red"></i>
                                <i class="fa fa-star-o star-red"></i>
                                <i class="fa fa-star-o star-red"></i>
                                and up
                                {{!-- <small>({{numProducts}})</small> --}}
                            </label>
                        </div>
                    </div>
                </div>
                <!-- /aside Rating Widget -->

                <!-- aside Price Widget -->
                <div class="aside">
                    <h3 class="aside-title">Price</h3>
                    <div class="price-filter">
                        <div class="input-number price-min">
                            <input id="price-min" type="number" value="" placeholder="From" name="pricemin">

                        </div>
                        <span>-</span>
                        <div class="input-number price-max">
                            <input id="price-max" type="number" value="" placeholder="To" name="pricemax">

                        </div>
                    </div>
                </div>
                <!-- /aside Price Widget -->

                <!-- aside Top Selling Widget -->
                {{!-- <div class="aside">
                    <h3 class="aside-title">Top selling</h3>
                    <div class="product-widget">
                        <div class="product-img">
                            <img src="/store/img/product01.png" alt="">
                        </div>
                        <div class="product-body">
                            <p class="product-category">Category</p>
                            <h3 class="product-name"><a href="#">product name goes here</a></h3>
                            <h4 class="product-price">$980.00 <del class="product-old-price">$990.00</del></h4>
                        </div>
                    </div>

                    <div class="product-widget">
                        <div class="product-img">
                            <img src="/store/img/product02.png" alt="">
                        </div>
                        <div class="product-body">
                            <p class="product-category">Category</p>
                            <h3 class="product-name"><a href="#">product name goes here</a></h3>
                            <h4 class="product-price">$980.00 <del class="product-old-price">$990.00</del></h4>
                        </div>
                    </div>

                    <div class="product-widget">
                        <div class="product-img">
                            <img src="/store/img/product03.png" alt="">
                        </div>
                        <div class="product-body">
                            <p class="product-category">Category</p>
                            <h3 class="product-name"><a href="#">product name goes here</a></h3>
                            <h4 class="product-price">$980.00 <del class="product-old-price">$990.00</del></h4>
                        </div>
                    </div>
                </div> --}}
                </form>
                <!-- /aside Widget -->
            </div>
            <!-- /ASIDE -->

            <!-- STORE -->
            <div id="store" class="col-md-9">
                <!-- store top filter -->
                <div class="store-filter clearfix">
                    <div class="store-sort">
                        {{!-- <label>
                            Sort By:
                            <select class="input-select">
                                <option value="0">None</option>
                                <option value="1">Price: Highest to Lowest</option>
                                <option value="2">Price: Lowest to Highest</option>
                            </select>
                        </label> --}}
                        <label>
                            Show:
                            <select id="show-limit" name="limit" class="input-select">
                                <option value="12">12</option>
                                <option value="24">24</option>
                                <option value="36">36</option>
                                <option value="3">3</option>
                            </select>
                        </label>
                    </div>
                    {{!-- <ul class="store-grid">
                        <li class="active"><i class="fa fa-th"></i></li>
                        <li><a href="#"><i class="fa fa-th-list"></i></a></li>
                    </ul> --}}
                </div>
                <!-- /store top filter -->
                <!-- store products -->
                <div id="product-list" class="row store-flex">
                    <!-- product -->
                </div>
                <!-- /store products -->
                <!-- store bottom filter -->
                <div class="store-filter clearfix">
                    <span class="store-qty"></span>
                    <ul class="store-pagination">
                    
                    </ul>
                </div>
                <!-- /store bottom filter -->
            </div>
            <!-- /STORE -->
        </div>
        <!-- /row -->
    </div>
    <!-- /container -->
</div>
<!-- /SECTION -->
{{#section "fetch"}}
<script src="/store/js/helper.js"></script>
<script>
    const urlSearchParams = new URLSearchParams(window.location.search);
    const getProducts = async (page) => {
        try {
            const params = Object.fromEntries(urlSearchParams.entries()); // Get filter from Search Params
            params.page = page;
            const res = await fetch(`/api/product/?limit=${params.limit}&page=${params.page}&category=${params.category}&brand=${params.brand}&rating=${params.rating}&pricemin=${params.pricemin}&pricemax=${params.pricemax}`);
            if(!res.ok) {
                const message = "Error with status code: " + res.status;
                throw new Error(message);
            }
            const api = await res.json();
            $('#product-list').empty();
            $('.store-qty').empty();
            if(api.rows.length > 0) {
                api.rows.forEach(product => {
                    $('#product-list').append(`
                        <div class="col-md-4 col-xs-6">
                            <div class="product">
                                <div class="product-img">
                                    <img src="/store/img/${product.thumbnail}" alt="">
                                    {{!-- <div class="product-label">
                                        <span class="sale">-30%</span>
                                        <span class="new">NEW</span>
                                    </div> --}}
                                </div>
                                <div class="product-body">
                                    <p class="product-category">${product.nameCategory} - ${product.brand}</p>
                                    <h3 class="product-name"><a href="/products/${product.idProduct}">${product.name}</a></h3>
                                    <h4 class="product-price">$${product.price}</h4>
                                    <div class="product-rating">
                                        ${rating_star(product.avgRating)}
                                    </div>
                                    <div class="product-btns">
                                        <button class="add-to-wishlist"><i class="fa fa-heart-o"></i><span class="tooltipp">add to wishlist</span></button>
                                        <button class="add-to-compare"><i class="fa fa-exchange"></i><span class="tooltipp">add to compare</span></button>
                                        <button class="quick-view"><i class="fa fa-eye"></i><span class="tooltipp">quick view</span></button>
                                    </div>
                                </div>
                                <div class="add-to-cart">
                                    <button class="add-to-cart-btn"><i class="fa fa-shopping-cart"></i> add to cart</button>
                                </div>
                            </div>
                        </div>
                    `)
                    
                });
                //$('.store-qty').text(`Showing ${api.limit} - ${api.count}`);
            }
            else {
                $('#product-list').append(`
                    <div class="not-found">
                        <div class="col-12 store-center">
                            <img src="/store/img/no-products-found.png">
                        </div>
                        <div class="col-12 store-center">
                            <p class="mt-2">No products found.</p>
                        </div>
                    </div>
                `);
            }
            const count = Math.ceil(api.count/api.limit);
            $('.store-pagination').html(paginationProduct(page,count))
            console.log('API: ',api);
        } catch (error) {
            console.log(error);
        }
    }
    getProducts(0);
    const reset_button = document.querySelector('#reset-btn');
    reset_button.addEventListener('click', function(e){
        urlSearchParams.delete('limit');
        urlSearchParams.delete('category');
        urlSearchParams.delete('brand');
        urlSearchParams.delete('rating');
        urlSearchParams.delete('page');
        urlSearchParams.delete('pricemin');
        urlSearchParams.delete('pricemax');
        var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + urlSearchParams;
        window.history.pushState({ path: newurl }, '', newurl);
        $('input[class=category-filter]:checked').prop('checked',false);
        $('input[class=brand-filter]:checked').prop('checked',false);
        $('input[class=rating-filter]:checked').prop('checked',false);
        $('#price-min').val("");
        $('#price-max').val("");
        getProducts(0);
    })
    const limit_filter = document.querySelector('#show-limit');
    limit_filter.addEventListener('change', function(e) {
        urlSearchParams.set('limit',limit_filter.value);
        urlSearchParams.delete('page');
        var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?' + urlSearchParams;
        window.history.pushState({ path: newurl }, '', newurl);
        getProducts(0);
    })
    const category_filter = document.querySelectorAll('.category-filter');
    category_filter.forEach(element => element.addEventListener('change', function(e){
        urlSearchParams.set('category',element.value);
        urlSearchParams.delete('page');
        var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?' + urlSearchParams;
        window.history.pushState({ path: newurl }, '', newurl);
        getProducts(0);
    }))
    const brand_filter = document.querySelectorAll('.brand-filter');
    brand_filter.forEach(element => element.addEventListener('change', function(e){
        urlSearchParams.set('brand',element.value);
        urlSearchParams.delete('page');
        var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?' + urlSearchParams;
        window.history.pushState({ path: newurl }, '', newurl);
        getProducts(0);
    }))
    const rating_filter = document.querySelectorAll('.rating-filter');
    rating_filter.forEach(element => element.addEventListener('change', function(e){
        urlSearchParams.set('rating',element.value);
        urlSearchParams.delete('page');
        var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?' + urlSearchParams;
        window.history.pushState({ path: newurl }, '', newurl);
        getProducts(0);
    }))
    const pricemin_filter = document.querySelector('#price-min');
    pricemin_filter.addEventListener('blur', function(e) {
        urlSearchParams.set('pricemin',pricemin_filter.value);
        urlSearchParams.delete('page');
        var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?' + urlSearchParams;
        window.history.pushState({ path: newurl }, '', newurl);
        getProducts(0);
    })
    const pricemax_filter = document.querySelector('#price-max');
    pricemax_filter.addEventListener('blur', function(e) {
        urlSearchParams.set('pricemax',pricemax_filter.value);
        urlSearchParams.delete('page');
        var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?' + urlSearchParams;
        window.history.pushState({ path: newurl }, '', newurl);
        getProducts(0);
    })
    const getProductsPage = (page) => {
        $('#top-header')[0].scrollIntoView();
        urlSearchParams.set('page',page);
        var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?' + urlSearchParams;
        window.history.pushState({ path: newurl }, '', newurl);
        getProducts(page);
    }
</script>
{{/section}}